# 电厂污染物排放预测系统 - 离线环境部署指南

本文档详细说明如何在方天公司离线环境（局域网）中部署电厂污染物排放预测系统。

## 目录

1. [系统架构](#系统架构)
2. [前置准备](#前置准备)
3. [镜像获取与传输](#镜像获取与传输)
4. [离线环境部署步骤](#离线环境部署步骤)
5. [验证系统](#验证系统)
6. [常见问题排查](#常见问题排查)
7. [环境清理](#环境清理)

## 系统架构

电厂污染物排放预测系统由以下服务组成：

- **主应用服务(app)**: 提供Web界面和API服务
- **数据库服务(db)**: PostgreSQL数据库，存储系统数据
- **缓存服务(redis)**: Redis缓存，提高系统性能
- **监控服务(prometheus)**: 系统运行指标收集
- **可视化监控(grafana)**: 监控数据可视化展示

这些服务被配置为相互通过服务名称而非IP地址通信，更适合容器化环境。

## 前置准备

### 硬件要求

- CPU: 双核或更高
- 内存: 8GB+
- 磁盘空间: 50GB+

### 软件要求

- Docker 19.03+
- Docker Compose 1.27+

### 检查环境

确认离线环境满足以下条件：

```bash
# 检查Docker版本
docker --version

# 检查Docker Compose版本
docker-compose --version

# 确认Docker服务运行状态
systemctl status docker  # Linux
# 或在Windows中检查Docker Desktop是否运行
```

## 镜像获取与传输

由于方天公司为离线环境，需要先在公网环境获取镜像，再传输到离线环境。

### 步骤1: 在公网环境获取镜像

在能够访问互联网的环境中，执行以下命令拉取所有必要的镜像：

```bash
# 拉取预测系统主镜像
docker pull 294802186/pollution-prediction:v1.0

# 拉取依赖服务镜像
docker pull postgres:14-alpine
docker pull redis:6-alpine
docker pull prom/prometheus:latest
docker pull grafana/grafana:latest
```

### 步骤2: 保存镜像为文件

```bash
# 创建保存镜像的目录
mkdir -p pollution-prediction-images

# 保存所有镜像
docker save 294802186/pollution-prediction:v1.0 > pollution-prediction-images/app.tar
docker save postgres:14-alpine > pollution-prediction-images/postgres.tar
docker save redis:6-alpine > pollution-prediction-images/redis.tar 
docker save prom/prometheus:latest > pollution-prediction-images/prometheus.tar
docker save grafana/grafana:latest > pollution-prediction-images/grafana.tar

# 打包所有镜像文件
tar -czvf pollution-prediction-images.tar.gz pollution-prediction-images
```

### 步骤3: 准备部署文件

除了镜像文件，还需要准备以下文件：

```bash
# 克隆仓库（如果没有）
git clone https://github.com/ShiXiangYu1/pollution-prediction-system.git

# 创建部署包
mkdir -p deploy-package
cp -r pollution-prediction-system/docker-compose.yml deploy-package/
cp -r pollution-prediction-system/prometheus deploy-package/
cp -r pollution-prediction-system/.env.example deploy-package/.env
cp -r pollution-prediction-system/离线环境部署指南.md deploy-package/

# 打包部署文件
tar -czvf deploy-package.tar.gz deploy-package
```

### 步骤4: 传输文件到离线环境

使用物理存储设备（如U盘、移动硬盘）或通过内网文件传输系统，将以下文件传输到方天公司离线环境：

- `pollution-prediction-images.tar.gz`（所有Docker镜像）
- `deploy-package.tar.gz`（部署配置文件）

## 离线环境部署步骤

在方天公司离线环境服务器上，按照以下步骤部署系统：

### 步骤1: 解压文件

```bash
# 解压镜像包
tar -xzvf pollution-prediction-images.tar.gz

# 解压部署配置包
tar -xzvf deploy-package.tar.gz

# 进入部署目录
cd deploy-package
```

### 步骤2: 加载Docker镜像

```bash
# 加载所有镜像
docker load < ../pollution-prediction-images/app.tar
docker load < ../pollution-prediction-images/postgres.tar
docker load < ../pollution-prediction-images/redis.tar
docker load < ../pollution-prediction-images/prometheus.tar
docker load < ../pollution-prediction-images/grafana.tar

# 验证镜像是否加载成功
docker images
```

### 步骤3: 准备目录结构

```bash
# 创建必要的目录
mkdir -p data logs models templates static init-scripts/db grafana/provisioning

# 创建必要的空文件（如果需要）
touch .env
```

### 步骤4: 修改配置文件（可选）

如需自定义配置，可编辑以下文件：

- `.env`: 环境变量配置
- `docker-compose.yml`: 容器编排配置
- `prometheus/prometheus.yml`: Prometheus监控配置

### 步骤5: 启动系统

```bash
# 启动所有服务
docker-compose up -d

# 查看容器启动状态
docker-compose ps
```

## 验证系统

系统启动后，可通过以下步骤验证各组件是否正常工作：

### 1. 检查容器状态

```bash
# 查看所有容器是否正常运行
docker ps

# 查看应用日志
docker logs pollution_prediction_app
```

### 2. 访问Web界面

在局域网内的计算机上，打开浏览器访问以下地址：

- 主应用：`http://<服务器IP>:8000`
- Grafana监控界面：`http://<服务器IP>:3000` (默认用户名/密码: admin/admin)
- Prometheus：`http://<服务器IP>:9090`

### 3. 功能测试

- 数据看板：`http://<服务器IP>:8000/dashboard`
- 排放预测：`http://<服务器IP>:8000/prediction`
- 自然语言查询：`http://<服务器IP>:8000/nlp`
- 语音识别查询：`http://<服务器IP>:8000/speech`

### 4. API测试

```bash
# 健康检查
curl http://<服务器IP>:8000/health

# 获取排放数据
curl http://<服务器IP>:8000/api/emissions
```

## 常见问题排查

### 容器无法启动

**问题**: 某些容器反复重启或无法启动

**解决方法**:
1. 查看容器日志：`docker logs <容器名>`
2. 检查磁盘空间：`df -h`
3. 确认端口是否被占用：`netstat -tulpn | grep <端口号>`
4. 尝试单独启动有问题的容器：`docker-compose up <服务名>`

### 服务之间无法通信

**问题**: 应用无法连接数据库或其它服务

**解决方法**:
1. 确认所有容器在同一网络：`docker network inspect app_network`
2. 检查环境变量是否正确：`docker exec pollution_prediction_app env | grep DATABASE_URL`
3. 尝试从应用容器ping其他服务：`docker exec pollution_prediction_app ping db`

### 静态文件404错误

**问题**: 网页显示但CSS/JS等静态资源加载失败

**解决方法**:
1. 确认静态文件目录已正确挂载：`docker exec pollution_prediction_app ls -la /app/static`
2. 检查模板文件：`docker exec pollution_prediction_app cat /app/templates/base.html`
3. 重启应用容器：`docker-compose restart app`

## 环境清理

当不再需要运行系统时，可以清理环境：

```bash
# 停止所有容器
docker-compose down

# 如果需要删除持久化数据
docker-compose down -v

# 删除所有相关镜像
docker rmi 294802186/pollution-prediction:v1.0 postgres:14-alpine redis:6-alpine prom/prometheus:latest grafana/grafana:latest
```

## 技术支持

如遇到无法解决的问题，请联系技术支持：

- 联系人：技术支持团队
- 邮箱：support@powerplant-tech.com
- 电话：400-123-4567 